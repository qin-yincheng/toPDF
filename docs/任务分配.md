# 3天MVP任务分配表

## 项目概述

**目标**：3天内完成私募基金年度报告PDF生成系统（MVP版本）  
**团队**：3人  
**技术栈**：Python, pandas, reportlab, matplotlib  
**Git协作**：使用feature分支，每日合并

---

## MVP简化方案

### 核心功能（保留）
- ✅ 交割单Excel读取
- ✅ 持仓计算（数量、成本、市值）
- ✅ 基础指标计算（收益率、回撤、夏普比率）
- ✅ 3个核心图表（净值走势、回撤图、持仓分布）
- ✅ 2页PDF报告（业绩统计、持仓明细）

### 简化功能（暂不实现）
- ❌ Tushare实时API（使用mock数据）
- ❌ 复杂归因分析（Brinson等）
- ❌ 行业分析
- ❌ 多时间段对比
- ❌ 期货/债券等复杂资产

---

## 项目结构（MVP简化版）

```
toPDF/
├── config.py              # 配置文件（产品信息、初始资金等）
├── data/
│   └── reader.py         # 交割单读取（开发者A）
├── calc/
│   ├── position.py       # 持仓计算（开发者A）
│   ├── metrics.py        # 指标计算（开发者B）
│   └── utils.py          # 计算工具函数（开发者B）
├── charts/
│   └── generator.py      # 图表生成（开发者C）
├── pdf/
│   ├── generator.py       # PDF生成主类（开发者C）
│   └── pages.py          # 页面生成函数（开发者C）
├── main.py                # 主入口（Day3集成）
└── requirements.txt       # 依赖
```

---

## 模块详细说明

### 模块1：数据读取模块 (`data/reader.py`)
**负责人**：开发者A  
**职责**：读取Excel交割单，解析交易记录

**主要函数**：
```python
def read_excel(file_path: str) -> pd.DataFrame:
    """
    读取交割单Excel文件
    输入: Excel文件路径
    输出: DataFrame，包含列：date, code, name, direction, quantity, price, amount, fee
    """
    
def validate_data(df: pd.DataFrame) -> bool:
    """
    验证数据格式
    输入: DataFrame
    输出: bool（是否有效）
    """
```

**输入**：`交割单.xlsx`  
**输出**：`pd.DataFrame` - 标准化的交易记录

---

### 模块2：持仓计算模块 (`calc/position.py`)
**负责人**：开发者A  
**职责**：计算持仓数量、成本、市值

**主要函数**：
```python
def calculate_positions(transactions: pd.DataFrame, end_date: str) -> Dict[str, Dict]:
    """
    计算指定日期的持仓
    输入: 交易记录DataFrame, 结束日期
    输出: {code: {'quantity': float, 'cost': float, 'market_value': float}}
    """
    
def calculate_daily_positions(transactions: pd.DataFrame, date_range: List[str]) -> List[Dict]:
    """
    计算每日持仓（用于净值计算）
    输入: 交易记录, 日期列表
    输出: [{date, positions, total_assets}, ...]
    """
    
def get_stock_price(code: str, date: str) -> float:
    """
    获取股票价格（MVP版本：使用mock数据或简单计算）
    输入: 股票代码, 日期
    输出: 价格（元）
    """
```

**输入**：交易记录DataFrame  
**输出**：持仓字典、每日持仓列表

---

### 模块3：指标计算模块 (`calc/metrics.py`)
**负责人**：开发者B  
**职责**：计算收益率、回撤、波动率、夏普比率等

**主要函数**：
```python
def calculate_nav(daily_positions: List[Dict], initial_capital: float) -> List[Dict]:
    """
    计算每日净值
    输入: 每日持仓列表, 初始资金
    输出: [{date, nav, total_assets}, ...]
    """
    
def calculate_returns(nav_data: List[Dict]) -> Dict[str, float]:
    """
    计算收益率指标
    输入: 净值数据列表
    输出: {'period_return': float, 'annualized_return': float}
    """
    
def calculate_max_drawdown(nav_data: List[Dict]) -> float:
    """
    计算最大回撤
    输入: 净值数据列表
    输出: 最大回撤百分比
    """
    
def calculate_volatility(nav_data: List[Dict]) -> float:
    """
    计算年化波动率
    输入: 净值数据列表
    输出: 年化波动率百分比
    """
    
def calculate_sharpe_ratio(annualized_return: float, volatility: float, risk_free: float = 0.03) -> float:
    """
    计算夏普比率
    输入: 年化收益率, 年化波动率, 无风险利率
    输出: 夏普比率
    """
```

**输入**：每日持仓数据、初始资金  
**输出**：各种指标字典

---

### 模块4：图表生成模块 (`charts/generator.py`)
**负责人**：开发者C  
**职责**：生成3个核心图表

**主要函数**：
```python
def plot_nav_trend(nav_data: List[Dict], save_path: str) -> str:
    """
    绘制净值走势图
    输入: 净值数据列表, 保存路径
    输出: 图片文件路径
    """
    
def plot_drawdown(nav_data: List[Dict], save_path: str) -> str:
    """
    绘制回撤图
    输入: 净值数据列表, 保存路径
    输出: 图片文件路径
    """
    
def plot_position_distribution(positions: Dict[str, Dict], save_path: str) -> str:
    """
    绘制持仓分布图（饼图或柱状图）
    输入: 持仓字典, 保存路径
    输出: 图片文件路径
    """
```

**输入**：净值数据、持仓数据  
**输出**：图表图片文件路径

---

### 模块5：PDF生成模块 (`pdf/generator.py` + `pdf/pages.py`)
**负责人**：开发者C  
**职责**：生成PDF报告

**主要函数**：
```python
# pdf/generator.py
class PDFGenerator:
    def __init__(self, output_path: str):
        """初始化PDF生成器"""
    
    def add_page(self, page_func):
        """添加页面"""
    
    def save(self):
        """保存PDF"""
        
# pdf/pages.py
def generate_page1_metrics(generator: PDFGenerator, metrics: Dict, nav_data: List[Dict]) -> None:
    """
    生成第一页：业绩统计
    输入: PDF生成器, 指标字典, 净值数据
    """
    
def generate_page2_positions(generator: PDFGenerator, positions: Dict[str, Dict], charts: List[str]) -> None:
    """
    生成第二页：持仓明细
    输入: PDF生成器, 持仓字典, 图表路径列表
    """
```

**输入**：指标数据、持仓数据、图表路径  
**输出**：PDF文件

---

## 3天任务分配

### Day 1：数据层与计算层（并行开发）

#### 开发者A：数据读取 + 持仓计算
**任务A1：交割单读取模块** [4小时]
- [ ] 创建 `data/reader.py`
- [ ] 实现Excel读取（pandas）
- [ ] 实现数据清洗和验证
- [ ] 输出标准化的交易记录DataFrame

**任务A2：持仓计算模块** [4小时]
- [ ] 创建 `calc/position.py`
- [ ] 实现 `calculate_positions()` - 计算持仓
- [ ] 实现 `calculate_daily_positions()` - 每日持仓
- [ ] 实现 `get_stock_price()` - 价格获取（mock版本）
- [ ] 输出持仓字典和每日持仓列表

**分支**：`feature/A-data-calc`

---

#### 开发者B：指标计算模块
**任务B1：净值计算** [2小时]
- [ ] 创建 `calc/utils.py`
- [ ] 实现日期工具函数
- [ ] 实现交易日判断

**任务B2：指标计算模块** [6小时]
- [ ] 创建 `calc/metrics.py`
- [ ] 实现 `calculate_nav()` - 净值计算
- [ ] 实现 `calculate_returns()` - 收益率
- [ ] 实现 `calculate_max_drawdown()` - 最大回撤
- [ ] 实现 `calculate_volatility()` - 波动率
- [ ] 实现 `calculate_sharpe_ratio()` - 夏普比率
- [ ] 输出指标字典

**分支**：`feature/B-metrics`

---

#### 开发者C：准备图表和PDF基础
**任务C1：环境准备** [2小时]
- [ ] 创建项目结构
- [ ] 配置 `requirements.txt`
- [ ] 测试matplotlib和reportlab

**任务C2：图表基础框架** [6小时]
- [ ] 创建 `charts/generator.py`
- [ ] 实现图表基础配置（中文字体）
- [ ] 实现 `plot_nav_trend()` - 净值走势图（使用mock数据测试）
- [ ] 实现 `plot_drawdown()` - 回撤图（使用mock数据测试）
- [ ] 实现 `plot_position_distribution()` - 持仓分布图（使用mock数据测试）

**分支**：`feature/C-charts`

---

### Day 2：集成与图表完成

#### 开发者A：完成持仓计算 + 协助测试
**任务A3：集成测试** [2小时]
- [ ] 与开发者B的指标计算模块集成测试
- [ ] 修复数据格式问题
- [ ] 优化持仓计算性能

**任务A4：价格数据Mock优化** [2小时]
- [ ] 优化 `get_stock_price()` 函数
- [ ] 实现简单的价格缓存机制
- [ ] 处理非交易日情况

**任务A5：代码优化与数据格式准备** [2小时]
- [ ] 代码审查和优化
- [ ] 添加必要注释
- [ ] 为PDF生成准备数据格式转换函数
- [ ] 更新文档

---

#### 开发者B：完成指标计算 + 集成
**任务B3：集成测试** [2小时]
- [ ] 与开发者A的持仓计算模块集成
- [ ] 验证计算准确性
- [ ] 修复计算bug

**任务B4：补充计算函数** [2小时]
- [ ] 实现 `calc/utils.py` 工具函数
- [ ] 实现日期范围生成
- [ ] 实现数据验证函数

**任务B5：代码优化与数据格式准备** [2小时]
- [ ] 代码审查和优化
- [ ] 添加单元测试（简单版本）
- [ ] 为PDF生成准备指标数据格式化函数
- [ ] 更新文档

---

#### 开发者C：完成图表 + PDF基础
**任务C3：图表完成** [3小时]
- [ ] 完成所有图表函数
- [ ] 与真实数据集成测试
- [ ] 优化图表样式

**任务C4：PDF生成基础** [3小时]
- [ ] 创建 `pdf/generator.py` - PDF生成类
- [ ] 创建 `pdf/pages.py` - 页面生成函数
- [ ] 实现中文字体配置
- [ ] 实现基础页面布局

**分支合并**：合并 `feature/C-charts` 到 `develop`

---

### Day 3：PDF完成与整体集成

#### 开发者A：主程序 + 配置 + 协助
**任务A6：配置文件** [1小时]
- [ ] 创建 `config.py`
- [ ] 定义产品基本信息
- [ ] 定义初始资金等参数

**任务A7：主程序集成** [2小时]
- [ ] 创建 `main.py`
- [ ] 整合所有模块
- [ ] 实现命令行参数
- [ ] 实现错误处理

**任务A8：协助PDF数据准备** [1小时]
- [ ] 协助开发者C准备持仓数据格式
- [ ] 测试数据流转

**分支合并**：合并 `feature/A-data-calc` 到 `develop`

---

#### 开发者B：测试与优化 + 协助
**任务B6：完整测试** [2小时]
- [ ] 端到端测试
- [ ] 验证计算结果
- [ ] 修复发现的问题

**任务B7：性能优化与协助PDF** [2小时]
- [ ] 优化计算性能
- [ ] 添加缓存机制
- [ ] 协助开发者C准备指标数据格式

**分支合并**：合并 `feature/B-metrics` 到 `develop`

---

#### 开发者C：PDF完成 + 最终优化
**任务C5：PDF页面完成** [3小时]
- [ ] 完成 `generate_page1_metrics()` - 第一页业绩统计
- [ ] 完成 `generate_page2_positions()` - 第二页持仓明细
- [ ] 插入图表到PDF
- [ ] 优化页面布局

**任务C6：最终优化与测试** [2小时]
- [ ] PDF样式优化
- [ ] 图表大小调整
- [ ] 最终测试
- [ ] 与主程序集成测试

**分支合并**：合并所有分支到 `main`

---

## 工作量统计（平均分配）

### 开发者A总计：18小时
- Day 1: 8小时 (A1: 4h + A2: 4h)
- Day 2: 6小时 (A3: 2h + A4: 2h + A5: 2h)
- Day 3: 4小时 (A6: 1h + A7: 2h + A8: 1h)

### 开发者B总计：18小时
- Day 1: 8小时 (B1: 2h + B2: 6h)
- Day 2: 6小时 (B3: 2h + B4: 2h + B5: 2h)
- Day 3: 4小时 (B6: 2h + B7: 2h)

### 开发者C总计：18小时
- Day 1: 8小时 (C1: 2h + C2: 6h)
- Day 2: 6小时 (C3: 3h + C4: 3h)
- Day 3: 4小时 (C5: 3h + C6: 2h)

**✅ 三人工作量完全平均：每人18小时**

---

## Git分支命名方案

### 主分支
- `main` - 主分支，稳定版本
- `develop` - 开发分支，每日合并

### Feature分支（按开发者）
- `feature/A-data-calc` - 开发者A的数据和计算模块
- `feature/B-metrics` - 开发者B的指标计算模块
- `feature/C-charts` - 开发者C的图表和PDF模块

### 命名规范
- **Feature分支**：`feature/{开发者标识}-{功能描述}`
- **提交信息**：`[模块] 功能描述`，如：
  - `[持仓计算] 实现持仓数量计算`
  - `[指标计算] 实现最大回撤计算`
  - `[图表] 完成净值走势图`

### 协作流程
1. 从 `develop` 创建feature分支
2. 每日开发完成后合并到 `develop`
3. Day3结束时合并所有分支到 `main`

---

## 开发者AI辅助提示词

### 开发者A的提示词
```
我正在开发一个私募基金报告生成系统，负责数据读取和持仓计算模块。

当前任务：
- 模块：data/reader.py - 读取Excel交割单
- 模块：calc/position.py - 计算持仓数量、成本、市值

技术要求：
1. 使用pandas读取Excel文件
2. 数据格式：date(日期), code(股票代码), name(股票名称), direction(买入/卖出), quantity(数量), price(价格), amount(金额), fee(手续费)
3. 持仓计算使用加权平均法计算成本
4. 价格获取暂时使用mock数据（简单实现：可以用随机价格或固定价格）
5. 所有函数必须有类型注解和docstring
6. 遵循PEP 8规范

输出格式：
- 持仓字典格式：{code: {'quantity': float, 'cost': float, 'market_value': float}}
- 每日持仓格式：[{date: str, positions: Dict, total_assets: float}, ...]

请帮我实现这些函数，代码要简洁高效。
```

### 开发者B的提示词
```
我正在开发一个私募基金报告生成系统，负责指标计算模块。

当前任务：
- 模块：calc/metrics.py - 计算收益率、回撤、波动率、夏普比率

计算公式：
1. 净值 = 总资产 / 初始资金
2. 期间收益率 = (期末净值 - 期初净值) / 期初净值 × 100%
3. 年化收益率 = ((1 + 期间收益率) ^ (365 / 天数)) - 1 × 100%
4. 最大回撤 = max((峰值 - 当前值) / 峰值 × 100%)
5. 年化波动率 = std(日收益率) × sqrt(252) × 100%
6. 夏普比率 = (年化收益率 - 无风险利率) / 年化波动率（无风险利率默认3%）

输入数据格式：
- 每日持仓：[{date: str, positions: Dict, total_assets: float}, ...]
- 初始资金：float

输出格式：
- 净值数据：[{date: str, nav: float, total_assets: float}, ...]
- 指标字典：{'period_return': float, 'annualized_return': float, 'max_drawdown': float, 'volatility': float, 'sharpe_ratio': float}

技术要求：
1. 使用numpy进行数值计算
2. 所有函数必须有类型注解和docstring
3. 遵循PEP 8规范
4. 处理边界情况（如除零、空数据等）

请帮我实现这些计算函数，确保计算准确。
```

### 开发者C的提示词
```
我正在开发一个私募基金报告生成系统，负责图表生成和PDF生成。

当前任务：
1. 模块：charts/generator.py - 生成3个图表
2. 模块：pdf/generator.py - PDF生成主类
3. 模块：pdf/pages.py - PDF页面生成

图表要求：
1. 净值走势图：折线图，X轴日期，Y轴净值，标题"单位净值走势"
2. 回撤图：折线图，X轴日期，Y轴回撤百分比，填充区域，标题"动态回撤"
3. 持仓分布图：饼图或横向柱状图，显示持仓占比，标题"持仓分布"

PDF要求：
1. 使用reportlab生成PDF
2. 配置中文字体（SimHei, SimSun）
3. 第一页：产品基本信息 + 业绩统计表格 + 净值走势图
4. 第二页：持仓明细表格 + 回撤图 + 持仓分布图
5. A4纸张大小，合理布局

技术要求：
1. matplotlib图表保存为PNG格式，300 DPI
2. reportlab插入图片到PDF
3. 表格使用reportlab的Table
4. 所有函数必须有类型注解和docstring
5. 遵循PEP 8规范

输入数据格式：
- 净值数据：[{date: str, nav: float}, ...]
- 持仓数据：{code: {'quantity': float, 'market_value': float, ...}, ...}
- 指标数据：{'period_return': float, 'annualized_return': float, ...}

请帮我实现这些功能，确保PDF美观且格式正确。
```

---

## 接口规范（简化版）

### 数据传递格式

#### 1. 交易记录（DataFrame）
```python
columns = ['date', 'code', 'name', 'direction', 'quantity', 'price', 'amount', 'fee']
# date: 'YYYY-MM-DD'
# direction: '买入' 或 '卖出'
```

#### 2. 持仓字典
```python
{
    'code': {
        'quantity': float,      # 持仓数量
        'cost': float,          # 持仓成本（万元）
        'market_value': float   # 持仓市值（万元）
    }
}
```

#### 3. 每日持仓列表
```python
[
    {
        'date': '2024-01-01',
        'positions': {code: {...}},  # 持仓字典
        'total_assets': float        # 总资产（万元）
    },
    ...
]
```

#### 4. 净值数据列表
```python
[
    {
        'date': '2024-01-01',
        'nav': float,           # 单位净值
        'total_assets': float  # 总资产（万元）
    },
    ...
]
```

#### 5. 指标字典
```python
{
    'period_return': float,        # 期间收益率（%）
    'annualized_return': float,    # 年化收益率（%）
    'max_drawdown': float,         # 最大回撤（%）
    'volatility': float,           # 年化波动率（%）
    'sharpe_ratio': float          # 夏普比率
}
```

---

## 每日协作流程

### Day 1 结束
1. 开发者A提交代码到 `feature/A-data-calc`
2. 开发者B提交代码到 `feature/B-metrics`
3. 开发者C提交代码到 `feature/C-charts`
4. **不合并**，各自继续开发

### Day 2 结束
1. 开发者A合并 `feature/A-data-calc` 到 `develop`
2. 开发者B合并 `feature/B-metrics` 到 `develop`
3. 开发者C合并 `feature/C-charts` 到 `develop`
4. 所有人从 `develop` 拉取最新代码
5. 进行集成测试，修复接口问题

### Day 3 结束
1. 完成所有功能
2. 合并 `develop` 到 `main`
3. 生成最终版本

---

## 验收标准（MVP）

### 功能验收
- [ ] 能成功读取交割单Excel
- [ ] 能正确计算持仓和收益
- [ ] 能正确计算基础指标（收益率、回撤、夏普比率）
- [ ] 能生成3个图表（净值、回撤、持仓分布）
- [ ] 能生成2页PDF报告
- [ ] PDF格式正确，中文显示正常

### 代码验收
- [ ] 代码符合PEP 8规范
- [ ] 函数有类型注解和docstring
- [ ] 无严重bug

---

## 快速开始

### 环境配置
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install pandas openpyxl matplotlib reportlab numpy
```

### 运行流程
```python
# main.py 示例
from data.reader import read_excel
from calc.position import calculate_positions, calculate_daily_positions
from calc.metrics import calculate_nav, calculate_returns, calculate_max_drawdown
from charts.generator import plot_nav_trend, plot_drawdown, plot_position_distribution
from pdf.generator import PDFGenerator
from pdf.pages import generate_page1_metrics, generate_page2_positions

# 1. 读取数据
transactions = read_excel('交割单.xlsx')

# 2. 计算持仓
end_date = '2024-12-31'
positions = calculate_positions(transactions, end_date)
daily_positions = calculate_daily_positions(transactions, date_range)

# 3. 计算指标
nav_data = calculate_nav(daily_positions, initial_capital=1000)
metrics = {
    **calculate_returns(nav_data),
    'max_drawdown': calculate_max_drawdown(nav_data),
    'volatility': calculate_volatility(nav_data),
    'sharpe_ratio': calculate_sharpe_ratio(...)
}

# 4. 生成图表
chart1 = plot_nav_trend(nav_data, 'nav_trend.png')
chart2 = plot_drawdown(nav_data, 'drawdown.png')
chart3 = plot_position_distribution(positions, 'positions.png')

# 5. 生成PDF
pdf = PDFGenerator('report.pdf')
generate_page1_metrics(pdf, metrics, nav_data)
generate_page2_positions(pdf, positions, [chart1, chart2, chart3])
pdf.save()
```

---

## 注意事项

1. **数据格式统一**：所有日期使用 'YYYY-MM-DD' 格式
2. **金额单位**：统一使用万元
3. **错误处理**：关键函数要有异常处理
4. **日志记录**：使用print或logging记录关键步骤
5. **Mock数据**：价格获取暂时用简单实现，后续可替换
6. **Git提交**：频繁提交，每次提交要有清晰描述

---

## 总结

本MVP版本将原本复杂的项目简化为核心功能，3天内可完成：
- **开发者A**：数据读取和持仓计算（8小时）
- **开发者B**：指标计算（8小时）
- **开发者C**：图表和PDF生成（12小时）

通过明确的模块划分和接口定义，三人可以并行开发，最后集成完成。

