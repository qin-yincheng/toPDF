# 私募基金报告生成系统 📊

```
 ╔════════════════════════════════════════════════════════════╗
 ║  交割单 CSV → 数据分析 → 图表生成 → PDF 报告 (一键生成)    ║
 ╚════════════════════════════════════════════════════════════╝
```

基于交割单数据自动生成私募基金分析报告，包含完整的数据处理、指标计算和图表生成功能。

## ✨ 核心特性

```
┌─────────────────────────────────────────────────────────────┐
│  📊 图表系统          16种专业图表（收益/持仓/归因）          │
│  � 数据接口          9个标准API（完全符合规范）              │
│  ⚡ 自动化            交割单 → PDF 一键生成                  │
│  💾 智能缓存          价格数据本地缓存，提速10x              │
│  📅 年度报告          支持跨年数据一致性                     │
│  � 基准对比          沪深300等基准动态归一化                │
│  🎨 跨平台字体        macOS/Windows/Linux自动适配            │
│  🔄 估值方法          成本法/市值法（瀑布流估值）            │
└─────────────────────────────────────────────────────────────┘
```

## 🚀 快速开始

```bash
# ① 克隆项目
git clone <repository-url>
cd toPDF

# ② 安装依赖
pip install -r requirements.txt

# ③ 设置 Tushare Token（必需）
export TUSHARE_TOKEN="your_token_here"
# 📌 注册地址：https://tushare.pro

# ④ 准备数据（支持 Excel 或 CSV）
# ✅ 自动检测：docs/交割单.xlsx 或 docs/交割单.csv

# ⑤ 生成PDF报告
python generate_report.py
```

**✅ 输出文件**：`私募基金报告_完整版.pdf`（~6.3MB，16页）

```
运行时间统计
├─ 首次运行：~30-60秒（需获取价格数据）
└─ 缓存后：  ~5-10秒（复用缓存）
```

## 📁 项目结构

```
toPDF/
│
├─ 📦 calc/                      ┌─ 核心计算模块 ──────────────┐
│  ├─ data_provider.py           │ ⭐ 9个标准数据接口          │
│  ├─ report_bridge.py           │ ⭐ PDF数据构建器(16数据集)  │
│  ├─ position.py                │ ⚙️  持仓计算引擎            │
│  ├─ attribution.py             │ 📊 绩效归因计算            │
│  ├─ metrics.py                 │ 📈 风险收益指标            │
│  ├─ trading.py                 │ 💱 交易统计                │
│  ├─ utils.py                   │ 🔧 工具函数                │
│  └─ formatter.py               └ 📝 数据格式化 ─────────────┘
│
├─ 📊 charts/                    ┌─ 图表生成模块(16个) ───────┐
│  ├─ 1_*.py  (7个)              │ 📈 收益与风险分析          │
│  ├─ 2_*.py  (5个)              │ 📊 持仓分析                │
│  ├─ 3_*.py  (4个)              │ 🥧 行业时序分析            │
│  ├─ 4_*.py  (2个)              │ 🎯 归因分析                │
│  └─ 5_6_*.py (3个)             └ 💼 交易分析 ───────────────┘
│
├─ 📄 pdf/                       ┌─ PDF生成模块 ──────────────┐
│  ├─ pages.py                   │ ⭐ 页面布局与图表组装      │
│  └─ chart_wrappers.py          └ 🎨 图表封装器 ─────────────┘
│
├─ 📂 data/                      ┌─ 数据处理模块 ─────────────┐
│  └─ reader.py                  └ 📖 Excel/CSV读取转换 ──────┘
│
├─ 📁 docs/                      ┌─ 文档与数据 ───────────────┐
│  ├─ 交割单.csv                 │ 📊 交易数据(79,203笔)      │
│  ├─ .cache/                    │ 💾 价格缓存目录            │
│  └─ *.md                       └ 📚 开发文档 ───────────────┘
│
├─ ⚙️  config.py                 ⭐ 全局配置
├─ 🚀 generate_report.py         ⭐ PDF生成入口
└─ 📋 requirements.txt           📦 依赖列表
```

## 🔄 运行流程

### 数据流转架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          📂 交割单.csv                              │
│                        (79,203 笔交易记录)                          │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  ① 数据读取与处理  (data_provider.py)                           ┃
┃  ┌────────────────────────────────────────────────────────┐     ┃
┃  │ • 解析交割单 79,203 笔                                  │     ┃
┃  │ • 计算每日持仓 3,958 天                                 │     ┃
┃  │ • 获取行业映射 3,667 只股票                             │     ┃
┃  │ • 获取基准数据 沪深300                                  │     ┃
┃  │ • Tushare API 价格数据（智能缓存）                      │     ┃
┃  └────────────────────────────────────────────────────────┘     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                               │ 9个标准API接口
                               ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  ② 指标计算  (attribution / metrics / position)               ┃
┃  ┌────────────────────────────────────────────────────────┐     ┃
┃  │ • 收益率计算（成立以来 + 5个区间）                      │     ┃
┃  │ • 风险指标（波动率/夏普/最大回撤）                      │     ┃
┃  │ • 归因分析（Brinson/行业/个股）                         │     ┃
┃  │ • 瀑布流估值（Tushare→交割单→时序填充→成本兜底）       │     ┃
┃  └────────────────────────────────────────────────────────┘     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                               │
                               ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  ③ 数据构建  (report_bridge.py)                               ┃
┃  ┌────────────────────────────────────────────────────────┐     ┃
┃  │ 构建 16 个数据集 → 格式化 → 验证补全                    │     ┃
┃  └────────────────────────────────────────────────────────┘     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                               │
                               ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  ④ 图表生成  (charts/*.py)                                    ┃
┃  ┌────────────────────────────────────────────────────────┐     ┃
┃  │ 📊 收益与风险 (7)  │ 📈 持仓分析 (5) │ 🎯 归因分析 (4) │     ┃
┃  │ matplotlib 绘图 → 自动处理空数据 → 统一字体样式        │     ┃
┃  └────────────────────────────────────────────────────────┘     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                               │
                               ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  ⑤ PDF组装  (pdf/pages.py)                                    ┃
┃  ┌────────────────────────────────────────────────────────┐     ┃
┃  │ A4横向排版 → 自动分页 → 图表缩放嵌入 → 生成PDF         │     ┃
┃  └────────────────────────────────────────────────────────┘     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│           📄 私募基金报告_完整版.pdf (6.3MB, 16页)                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 瀑布流估值逻辑（市值法）

```
                           🎯 目标：获取股票每日收盘价
                                       │
                     ┌─────────────────┴─────────────────┐
                     │                                   │
        ┌────────────▼────────────┐                     │
        │  🥇 优先级1：Tushare    │                     │
        │    官方收盘价数据        │                     │
        │  • 覆盖率: ~60%         │                     │
        │  • 数据权威准确          │                     │
        └─────────┬───────────────┘                     │
                  │ 有数据 ✓                            │
                  ▼                                     │
        ┌──────────────────────┐                        │
        │  价格完整，计算市值   │                        │
        └──────────────────────┘                        │
                                                        │ 无数据 ✗
                                                        │
                           ┌────────────────────────────┘
                           │
              ┌────────────▼────────────┐
              │  🥈 优先级2：交割单     │
              │    成交均价              │
              │  • 覆盖率: +17%         │
              │  • 填补停牌/退市         │
              └─────────┬───────────────┘
                        │ 有成交 ✓
                        ▼
              ┌──────────────────────┐
              │  用成交价填充缺失值   │
              └──────────────────────┘
                                                        
                        │ 仍有缺失 ✗
                        │
           ┌────────────▼────────────┐
           │  🥉 优先级3：时间填充    │
           │  • bfill: 新股上市前     │
           │  • ffill: 停牌退市后     │
           │  • 覆盖率: +23%         │
           └─────────┬───────────────┘
                     │ 填充完成 ✓
                     ▼
           ┌──────────────────────┐
           │  填补时序空缺         │
           └──────────────────────┘
                                                        
                     │ 仍无价格 ✗
                     │
        ┌────────────▼────────────┐
        │  🛡️ 优先级4：成本法兜底 │
        │  • 持仓成本估值          │
        │  • 覆盖率: 100%         │
        └─────────┬───────────────┘
                  │ 最终兜底 ✓
                  ▼
        ┌──────────────────────┐
        │  保证100%价格覆盖     │
        └──────────────────────┘
```

### 核心API接口

**9个标准数据接口**（data_provider.py）：

```
┌──────────────────────────────────────────────────────────────────┐
│  📊 持仓数据                                                      │
│  ├─ ① get_daily_positions()           # 每日持仓序列 (3,958天)  │
│  └─ ② get_position_details()          # 期间持仓明细 (3,761股)  │
├──────────────────────────────────────────────────────────────────┤
│  🏢 行业映射                                                      │
│  └─ ③ get_industry_mapping()          # 股票→行业 (3,667只)     │
├──────────────────────────────────────────────────────────────────┤
│  💱 交易数据                                                      │
│  ├─ ④ get_transactions()              # 交易记录 (79,203笔)     │
│  └─ ⑤ get_periods_config()            # 统计区间 (5个)          │
├──────────────────────────────────────────────────────────────────┤
│  📈 基准数据                                                      │
│  ├─ ⑥ get_benchmark_daily_data()      # 基准日度行情            │
│  ├─ ⑦ get_benchmark_returns()         # 基准区间收益            │
│  ├─ ⑧ get_benchmark_industry_weights()# 基准行业权重            │
│  └─ ⑨ get_benchmark_industry_returns()# 基准行业收益            │
└──────────────────────────────────────────────────────────────────┘
```

**16个数据构建器**（report_bridge.py）：

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 收益与风险分析 (7个)                                         │
│  ├─ build_overall_performance_data()      # 总体表现            │
│  ├─ build_scale_overview_data()           # 规模总览            │
│  ├─ build_nav_performance_data()          # 净值表现            │
│  ├─ build_daily_return_performance_data() # 日收益              │
│  ├─ build_period_returns_data()           # 区间收益            │
│  ├─ build_metrics_data()                  # 风险指标            │
│  └─ build_drawdown_data()                 # 回撤分析            │
├─────────────────────────────────────────────────────────────────┤
│  📈 持仓分析 (5个)                                               │
│  ├─ build_asset_allocation_series()       # 大类资产配置        │
│  ├─ build_end_holdings_data()             # 期末持仓            │
│  ├─ build_stock_position_series()         # 股票仓位            │
│  ├─ build_liquidity_series()              # 流动性资产          │
│  └─ build_industry_attribution_data()     # 行业分析            │
├─────────────────────────────────────────────────────────────────┤
│  🎯 归因分析 (2个)                                               │
│  ├─ build_asset_class_attribution()       # 大类资产归因        │
│  └─ build_brinson_data()                  # Brinson归因         │
├─────────────────────────────────────────────────────────────────┤
│  💼 交易分析 (2个)                                               │
│  ├─ build_turnover_data()                 # 换手率              │
│  └─ build_period_transaction_data()       # 期间交易            │
└─────────────────────────────────────────────────────────────────┘
```
build_nav_performance_data()          # 净值表现
build_daily_return_performance_data() # 日收益
build_period_returns_data()           # 区间收益
build_metrics_data()                  # 风险指标
build_drawdown_data()                 # 回撤分析

# 持仓分析（5个）
build_asset_allocation_series()       # 大类资产配置
build_end_holdings_data()             # 期末持仓
build_stock_position_series()         # 股票仓位
build_liquidity_series()              # 流动性资产
build_industry_attribution_data()     # 行业分析

# 归因分析（2个）
build_asset_class_attribution()       # 大类资产归因
build_brinson_data()                  # Brinson归因

# 交易分析（2个）
build_turnover_data()                 # 换手率
build_period_transaction_data()       # 期间交易
```

#### 步骤3：图表生成（`charts/*.py`）

每个图表模块包含：
- 数据验证和空值处理
- matplotlib 图表绘制
- 统一的中文字体配置
- 返回 figure 对象或保存为文件

```python
# 示例：生成收益分析图表
from charts.1_5 import plot_return_analysis_table

fig = plot_return_analysis_table(
    data=period_returns_data,
    return_figure=True,
    figsize=(16, 8)
)
```

#### 步骤4：PDF生成（`pdf/pages.py`）

**页面布局策略**：
- A4横向（297mm × 210mm）
- 页边距：左右各20mm，上下各15mm
- 自动分页：根据图表高度计算剩余空间
- 图表自适应缩放

```python
# 核心流程
def generate_pdf_pages(c, data, ...):
    # 1. 设置页面和字体
    # 2. 遍历16个图表模块
    # 3. 检查页面剩余空间
    # 4. 自动分页和图表插入
    # 5. 保存PDF文件
```
## 📖 核心API使用

### 数据接口层（data_provider.py）

详细示例见 [`docs/数据接口使用示例.md`](docs/数据接口使用示例.md)

```python
from calc.data_provider import (
    get_daily_positions,
    get_position_details,
    get_benchmark_returns,
    get_benchmark_industry_weights
)

# 获取每日持仓数据
daily_data = get_daily_positions()
# 返回：[
#   {"date": "2015-01-05", "total_assets": 1601.53, "cash": 1600.00, ...},
#   ...  # 3958天
# ]

# 获取期间持仓明细
details = get_position_details(
    period_start="2024-01-01",
    period_end="2024-12-31"
)
# 返回：{
#   "total_assets": 324898.33,
#   "total_profit": 323297.42,
#   "position_details": [...]  # 持仓明细列表
# }

# 获取基准收益率
returns = get_benchmark_returns("000300.SH")
# 返回：{"period_returns": {"成立以来": 27.07, "近一年": 5.23, ...}}

# 获取基准行业权重
weights = get_benchmark_industry_weights("000300.SH", "2024-11-01")
# 返回：{"银行": 11.31, "白酒": 7.82, ...}
```

### 报告生成层（report_bridge.py）

```python
from calc.report_bridge import (
    build_period_returns_data,
    build_asset_allocation_series,
    build_brinson_data
)

# 构建收益分析数据
returns_data = build_period_returns_data(
    daily_positions=daily_positions,
    benchmark_data=benchmark_data,
    periods=periods
)

# 构建资产配置数据
allocation_data = build_asset_allocation_series(
    daily_positions=daily_positions
)

# 构建Brinson归因数据
brinson_data = build_brinson_data(
    daily_positions=daily_positions,
    industry_mapping=industry_mapping,
    benchmark_industry_weights=weights,
    benchmark_industry_returns=returns
)
```

### PDF生成

```python
from pdf.generator import generate_pdf_report

# 一键生成完整PDF报告
generate_pdf_report(
    output_path="私募基金报告_完整版.pdf",
    csv_path="docs/交割单.csv",
    benchmark_code="000300.SH"
)
```

## ⚙️ 配置说明

### 环境变量

```bash
# 🔑 Tushare Token（必需）
export TUSHARE_TOKEN="your_token_here"
# 📌 注册地址：https://tushare.pro/register

# 💰 可选：初始资金（默认1000万元）
export INITIAL_CAPITAL=10000000
```

### config.py 核心配置

```python
┌─────────────────────────────────────────────────────────────────┐
│  基础配置                                                        │
│  ├─ DOCS_DIR            = "docs"              # 文档目录        │
│  ├─ INITIAL_CAPITAL     = 10_000_000.0        # 初始资金(元)   │
│  ├─ ESTABLISH_DATE      = None                # 自动推断        │
│  └─ BENCHMARK_CODE      = "000300.SH"         # 沪深300        │
├─────────────────────────────────────────────────────────────────┤
│  估值方法配置                                                    │
│  └─ VALUATION_METHOD    = "cost" / "market"   # 成本法/市值法  │
│                                                                  │
│     • cost   : 使用买入成本计算持仓价值                         │
│     • market : 使用每日收盘价计算（瀑布流估值）                 │
│                ├─ Tushare官方价（优先）                         │
│                ├─ 交割单成交价（填补）                          │
│                ├─ 时间序列填充（bfill/ffill）                   │
│                └─ 成本法兜底（100%覆盖）                        │
├─────────────────────────────────────────────────────────────────┤
│  报告年份限制（可选）                                            │
│  └─ REPORT_YEAR         = None / "2016"       # 年度报告       │
│                                                                  │
│     设置后的效果：                                               │
│     ✓ 筛选指定年份的交易和持仓数据                              │
│     ✓ 期初资产使用上一年12-31数据（跨年一致性）                 │
│     ✓ 基准归一化到该年第一个交易日                              │
│     ✓ 统计区间自动调整为该年度范围                              │
└─────────────────────────────────────────────────────────────────┘
```

### 数据格式要求

**输入文件**：`docs/交割单.csv`

```
必需列（6位数字代码）
├─ code              股票代码 (如 000001)
├─ buy_time          买入时间 (YYYY-MM-DD HH:MM:SS)
├─ sell_time         卖出时间 (YYYY-MM-DD HH:MM:SS)
├─ buy_price         买入价格 (元)
├─ sell_price        卖出价格 (元)
├─ buy_number        买入数量 (股)
├─ sell_number       卖出数量 (股)
├─ buy_money         买入金额 (元)
└─ sell_money        卖出金额 (元)
```

## 📊 数据规模

```
┌─────────────────────────────────────────────────────────────────┐
│  📥 输入数据                                                     │
│  ├─ 交割单记录         79,203 笔交易                           │
│  ├─ 交易股票数         3,768 只                                │
│  ├─ 行业映射           3,667 只股票                            │
│  ├─ 交易日期范围       3,958 天 (2015-01-05 ~ 2025-11-05)      │
│  └─ 基准数据           沪深300 (2,634 个交易日)                │
├─────────────────────────────────────────────────────────────────┤
│  📤 输出数据                                                     │
│  ├─ PDF报告           6.3 MB, 16 页                            │
│  ├─ 每日资产分布       3,958 行数据                            │
│  └─ 图表数量           16 个专业图表                            │
├─────────────────────────────────────────────────────────────────┤
│  💾 缓存数据                                                     │
│  ├─ 价格数据缓存       prices_*.pkl                            │
│  ├─ 行业映射缓存       industry_mapping.pkl                    │
│  └─ 缓存目录          docs/.cache/                             │
└─────────────────────────────────────────────────────────────────┘

数据单位约定
├─ 💰 资产/市值/收益    万元
├─ 💵 交易金额          元
├─ 📅 日期格式          YYYY-MM-DD
└─ 📊 百分比            % (如 15.6 = 15.6%)
```

## 📊 图表体系

报告包含 **16 种专业图表**，分为 5 大类别：

```
╔════════════════════════════════════════════════════════════════════╗
║                        📊 图表分类体系                             ║
╠════════════════════════════════════════════════════════════════════╣
║  📈 收益与风险分析 (7 个)                                          ║
║  ├─ 1.1  总体表现表格        │ 关键指标汇总                       ║
║  ├─ 1.2  产品规模总览        │ 资产规模时序图                     ║
║  ├─ 1.3  单位净值表现        │ 净值 vs 基准对比                   ║
║  ├─ 1.4  日收益表现          │ 日收益率分布                       ║
║  ├─ 1.5  收益分析表格        │ 多区间收益对比                     ║
║  ├─ 1.6  指标分析表格        │ 风险收益指标                       ║
║  └─ 1.7  动态回撤图          │ 最大回撤可视化                     ║
╠════════════════════════════════════════════════════════════════════╣
║  📊 持仓分析 (5 个)                                                ║
║  ├─ 2.1  大类持仓时序        │ 股票/债券/现金配置                 ║
║  ├─ 2.2  股票仓位时序        │ 股票仓位变化趋势                   ║
║  ├─ 2.3  期末持仓表格        │ 资产负债汇总表                     ║
║  ├─ 2.4  流动性资产时序      │ 流动性监控图                       ║
║  └─ 3.1  持股行业分析        │ 饼图+柱状图+表格                   ║
╠════════════════════════════════════════════════════════════════════╣
║  🥧 行业时序分析 (2 个)                                            ║
║  ├─ 3.2  持股行业占比时序    │ 行业配置堆叠图                     ║
║  └─ 3.3  持股行业偏离度      │ 相对基准偏离度                     ║
╠════════════════════════════════════════════════════════════════════╣
║  🎯 归因分析 (4 个)                                                ║
║  ├─ 3.4  大类资产绩效归因    │ 资产类别贡献                       ║
║  ├─ 4.1  Brinson归因         │ 选择收益+配置收益                  ║
║  ├─ 4.2  股票行业归因        │ TOP10盈利/亏损行业                 ║
║  └─ 5.1  股票绩效归因        │ TOP10盈利/亏损个股                 ║
╠════════════════════════════════════════════════════════════════════╣
║  💼 交易分析 (3 个)                                                ║
║  ├─ 5.2  个股持仓节点        │ 持仓规模分布                       ║
║  ├─ 6.4  换手率表格          │ 年化换手率统计                     ║
║  └─ 6.5  期间交易            │ 买卖金额统计                       ║
╚════════════════════════════════════════════════════════════════════╝
```

## 🧪 测试与演示

```bash
# ① 快速测试（推荐）
python generate_report.py
# 一键生成完整PDF报告，自动处理Excel转换

# ② 数据接口测试
python -c "
from calc.data_provider import get_daily_positions
data = get_daily_positions()
print(f'获取 {len(data)} 天数据')
print(f'最新日期: {data[-1][\"date\"]}')
print(f'总资产: {data[-1][\"total_assets\"]:.2f} 万元')
"

# ③ 生成每日资产分布CSV
python -m demo.generate_distribution_csv
```

## 🔧 故障排查

### 常见问题速查表

```
╔═══════════════════════════════════════════════════════════════════╗
║  ❌ 问题                        │  ✅ 解决方案                    ║
╠═══════════════════════════════════════════════════════════════════╣
║  ModuleNotFoundError            │  pip install -r requirements.txt║
║  (缺少模块)                     │                                 ║
╠═══════════════════════════════════════════════════════════════════╣
║  TushareException: 请设置TOKEN  │  export TUSHARE_TOKEN="..."    ║
║  (未设置Token)                  │  或在代码中 ts.set_token()     ║
╠═══════════════════════════════════════════════════════════════════╣
║  PDF图表显示为空/"暂无数据"     │  ① 检查交割单数据              ║
║  (数据缺失/异常)                │  ② rm -rf docs/.cache          ║
║                                 │  ③ 重新生成 PDF                ║
╠═══════════════════════════════════════════════════════════════════╣
║  跨年期初资产不一致             │  ✅ v1.2.0 已修复              ║
║  (期初≠上年期末)                │  期初使用日历期初(X-01-01)     ║
╠═══════════════════════════════════════════════════════════════════╣
║  沪深300基准线显示为平线        │  ✅ v1.2.0 已修复              ║
║  (基准归一化错误)               │  按报告年份归一化              ║
╠═══════════════════════════════════════════════════════════════════╣
║  图表中文显示为方框 □□□        │  安装中文字体：                ║
║  (缺少字体)                     │  • macOS: 自带PingFang         ║
║                                 │  • Windows: 自带微软雅黑       ║
║                                 │  • Linux: apt install          ║
║                                 │    fonts-wqy-microhei          ║
║                                 │  清除缓存：rm -rf              ║
║                                 │    ~/.matplotlib/fontlist*.json║
╠═══════════════════════════════════════════════════════════════════╣
║  list index out of range        │  ① 验证CSV格式                 ║
║  (数据格式错误)                 │  ② 检查日期范围                ║
║                                 │  ③ 清除缓存重新获取价格        ║
╚═══════════════════════════════════════════════════════════════════╝
```

### 详细排查步骤

**问题3：PDF图表显示为空**

```bash
# ① 检查数据文件
ls -lh docs/交割单.csv

# ② 清除缓存
rm -rf docs/.cache

# ③ 重新生成
python generate_report.py

# ④ 查看错误日志
python generate_report.py 2>&1 | grep "失败\|错误\|Exception"
```

**问题7：数据格式验证**

```bash
python -c "
import pandas as pd
df = pd.read_csv('docs/交割单.csv', encoding='utf-8-sig')
print('📊 数据行数:', len(df))
print('📋 列名:', df.columns.tolist())
print('🔍 示例数据:')
print(df.head(3))
"
```
python generate_report.py
```

**Q5: 图表中文显示为方框**

系统缺少中文字体，代码会自动尝试以下字体：
- SimHei（黑体）
- Microsoft YaHei（微软雅黑）
- Arial Unicode MS
- DejaVu Sans

如仍有问题，安装中文字体即可。

## 🔧 开发指南

### 添加新图表

1. **创建图表模块**（如 `charts/new_chart.py`）：
```python
def plot_new_chart(data, return_figure=False, figsize=(16, 8)):
    """新图表生成函数"""
    setup_chinese_font()
    
    # 数据验证
    if not data:
        return empty_chart("暂无数据")
    
    # 绘制图表
    fig, ax = plt.subplots(figsize=figsize)
    # ... 绘图代码 ...
    
    if return_figure:
        return fig
```

2. **添加数据构建器**（在 `calc/report_bridge.py`）：
```python
def build_new_chart_data(daily_positions, ...):
    """构建新图表所需数据"""
    # 数据计算和格式化
    return {
        "chart_data": [...],
        "summary": {...}
    }
```

3. **集成到PDF**（在 `pdf/pages.py`）：
```python
from charts.new_chart import plot_new_chart

# 在 generate_pdf_pages 中添加
fig_new = plot_new_chart(
    data=safe_get('new_chart_data'),
    return_figure=True
)
insert_figure(c, fig_new, x, y, width, height)
```

### 修改统计区间

编辑 `calc/data_provider.py` 的 `get_periods_config()`：

```python
def get_periods_config(csv_path=None):
    # 添加自定义区间
    periods = {
        "成立以来": (establish_date, latest_date),
        "近一年": (year_ago, latest_date),
        "近两年": (two_years_ago, latest_date),  # 新增
        "自定义": ("2023-01-01", "2023-12-31"),  # 新增
    }
    return periods
```

### 更换基准指数

```python
# 方法1：环境变量
export BENCHMARK_CODE="000905.SH"  # 中证500

# 方法2：代码修改 config.py
BENCHMARK_CODE = "399006.SZ"  # 创业板指
```

支持的指数：
- `000300.SH` - 沪深300
- `000905.SH` - 中证500  
- `000852.SH` - 中证1000
- `399006.SZ` - 创业板指
- `000001.SH` - 上证指数

## 🎨 跨平台字体配置

项目支持 **macOS、Windows、Linux** 跨平台中文显示。

### 字体自动选择策略

```
操作系统              │  字体优先级
─────────────────────┼────────────────────────────────
🍎 macOS             │  PingFang SC → Heiti SC → STHeiti
🪟 Windows           │  Microsoft YaHei → SimHei → SimSun
🐧 Linux             │  WenQuanYi Micro Hei → Noto Sans CJK
```

### 测试字体

```bash
# 查看系统可用字体和当前配置
python3 charts/font_config.py

# 输出: font_test.png（测试图片）
```

### 字体问题排查

```
问题症状：PDF中图表中文显示为 □□□ 或乱码

┌─────────────────────────────────────────────────────────┐
│  解决步骤                                                │
├─────────────────────────────────────────────────────────┤
│  ① macOS（通常无需操作）                                │
│     系统自带 PingFang SC 字体                           │
│                                                          │
│  ② Windows（Vista+ 自带）                               │
│     检查是否有"微软雅黑"字体                            │
│                                                          │
│  ③ Linux（需要安装）                                    │
│     # Ubuntu/Debian                                     │
│     sudo apt install fonts-wqy-microhei                 │
│                                                          │
│     # 或安装 Google Noto 字体                           │
│     sudo apt install fonts-noto-cjk                     │
│                                                          │
│  ④ 清除字体缓存（更新字体后）                           │
│     rm -rf ~/.matplotlib/fontlist*.json                 │
│                                                          │
│  ⑤ 验证修复                                             │
│     python generate_report.py                           │
│     检查PDF中的中文显示                                 │
└─────────────────────────────────────────────────────────┘
```

📖 **详细说明**：参见 [字体配置文档](docs/FONT_CONFIG.md)

**解决方案**：

1. **macOS**（通常自带）：
   ```bash
   # 检查字体
   ls /System/Library/Fonts/ | grep -i pingfang
   ```

2. **Windows**：确保已安装微软雅黑（Windows Vista+ 自带）

3. **Linux (Ubuntu/Debian)**：
   ```bash
   # 安装文泉驿字体
   sudo apt-get install fonts-wqy-microhei fonts-wqy-zenhei
   
   # 或安装 Google Noto 字体
   sudo apt-get install fonts-noto-cjk
   ```

4. **清除字体缓存**（如果更新字体后仍有问题）：
   ```bash
   rm -rf ~/.matplotlib/fontlist*.json
   ```

5. **验证修复**：重新生成 PDF 并检查图表

📖 **详细说明**：参见 [字体配置文档](docs/FONT_CONFIG.md)

## 📋 相关文档

```
docs/
├─ 📖 开发者A.md              数据接口详细规范
├─ 📖 开发者A补充.md          额外需求和说明
├─ 📖 模版模块实现.md         实现细节文档
├─ 📖 任务分配.md             开发者分工
└─ 🎨 FONT_CONFIG.md          跨平台字体配置指南
```

## 👥 贡献者

```
┌───────────────────────────────────────────────────────────┐
│  开发者A       数据层实现（9个标准API）                   │
│  开发者B       计算层实现（归因/指标/持仓）               │
│  开发者C       图表与PDF生成（16种图表）                  │
└───────────────────────────────────────────────────────────┘
```

## 📄 许可证

MIT License

---

<div align="center">

**🌟 如果这个项目对您有帮助，欢迎 Star！**

```
┌─────────────────────────────────────────────────────┐
│  Made with ❤️ by the toPDF Team                    │
│  📊 Professional Fund Reporting System              │
└─────────────────────────────────────────────────────┘
```

</div>

## 🛠️ 技术栈

```
┌────────────────────────────────────────────────────────────┐
│  核心技术                                                   │
│  ├─ 🐍 Python 3.8+           编程语言                      │
│  ├─ 📊 pandas                数据处理与分析                │
│  ├─ 💹 tushare               金融数据API                   │
│  ├─ 📈 matplotlib            图表绘制                       │
│  ├─ 📄 reportlab             PDF生成                       │
│  └─ 🔢 numpy                 数值计算                       │
└────────────────────────────────────────────────────────────┘
```

## 📝 更新日志

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  v1.3.0 (2025-11-13) - 瀑布流估值系统                     ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃  ✨ 新功能                                                 ┃
┃  ├─ 实现4级瀑布流估值逻辑                                 ┃
┃  │  ├─ 🥇 Tushare官方价（优先）                           ┃
┃  │  ├─ 🥈 交割单成交价（填补）                            ┃
┃  │  ├─ 🥉 时间序列填充（bfill/ffill）                     ┃
┃  │  └─ 🛡️ 成本法兜底（100%覆盖）                          ┃
┃  ├─ 激活"死代码" _build_price_from_trades                 ┃
┃  │  └─ 计算交割单加权平均价填补Tushare缺失                ┃
┃  └─ 新增 tushare_token 参数（优先级高于环境变量）        ┃
┃                                                            ┃
┃  📈 优化成果                                               ┃
┃  ├─ 价格覆盖率从 59.4% 提升到 100%                        ┃
┃  ├─ 交割单价格补充 620 只股票                             ┃
┃  └─ 市值法 vs 成本法差异仅 2.7%（合理范围）              ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  v1.2.0 (2025-11-11) - 数据一致性修复                     ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃  ✅ 跨年期初资产修复                                       ┃
┃  问题：2016期初(4005万) ≠ 2015期末(3994万)               ┃
┃  方案：使用日历期初(1-01)而非首个交易日(1-04)            ┃
┃  结果：✓ 跨年数据连续，期初=上年期末                      ┃
┃                                                            ┃
┃  ✅ 基准线显示修复                                         ┃
┃  问题：沪深300基准线显示为平线(全为1.0)                   ┃
┃  方案：传递基准净值 + 按报告年份归一化                    ┃
┃  结果：✓ 基准线正常波动(2016年24.92%)                     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  v1.1.0 (2025-11-09) - 跨平台字体支持                     ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃  ✅ 自动字体检测（macOS/Windows/Linux）                   ┃
┃  ✅ 统一字体配置模块 font_config.py                       ┃
┃  ✅ 更新全部21个图表使用统一配置                          ┃
┃  ✅ 修复期末持仓"证券/现金"显示错误                       ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  v1.0.0 (2025-11-08) - 首次发布                           ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃  ✅ 实现9个标准数据接口（100%符合规范）                   ┃
┃  ✅ 实现16种图表生成模块                                   ┃
┃  ✅ 完成PDF自动生成功能                                    ┃
┃  ✅ 智能缓存机制（10x加速）                                ┃
┃                                                            ┃
┃  📊 处理能力                                               ┃
┃  ├─ 79,203 笔交易记录                                     ┃
┃  ├─ 3,958 天持仓数据                                      ┃
┃  ├─ 3,761 只股票追踪                                      ┃
┃  └─ 6.3MB PDF报告（16页）                                 ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```
- 实现9个标准数据接口（100%符合规范）
- 实现16种图表生成模块
- 完成PDF自动生成功能
- 修复所有图表渲染问题
- 添加完善的空数据处理

📊 **性能指标**
- 处理79,203笔交易记录
- 计算3,958天持仓数据
- 追踪3,761只股票持仓
- 生成6.3MB完整PDF报告
- 运行时间：约30-60秒（首次），5-10秒（有缓存）

🎯 **质量保证**
- 所有16个图表模块正常工作
- 空数据场景自动处理
- 数据单位统一（万元）
- 日期格式标准化
- 中文字体跨平台适配

## 📄 许可证

MIT License

## 👥 贡献者

- 开发者A - 数据层实现
- 开发者B - 计算层实现  
- 开发者C - 图表与PDF生成
