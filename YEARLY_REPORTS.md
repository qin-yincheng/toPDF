# 按年生成报告使用说明

## 方法一：修改 config.py（推荐单个年份）

直接修改 `config.py` 中的两个配置：

```python
# 1. 使用完整交割单
CSV_FILE = DOCS_DIR / "交割单.csv"

# 2. 指定报告年份
REPORT_YEAR = "2024"  # 改成你想要的年份
```

然后运行：
```bash
python3 generate_report.py
```

生成的报告文件名：`私募基金报告_交割单.pdf`

---

## 方法二：使用批量生成脚本（推荐多个年份）

### 生成单个年份
```bash
python3 generate_yearly_reports.py 2024
```

### 生成多个年份
```bash
python3 generate_yearly_reports.py 2015 2016 2024
```

### 生成年份范围
```bash
python3 generate_yearly_reports.py 2015-2024
```

### 生成所有年份（2015-2025）
```bash
python3 generate_yearly_reports.py all
```

生成的报告文件名：`私募基金报告_交割单.pdf`（会被覆盖）

---

## 可用年份范围

根据交割单数据，支持生成以下年份的报告：

| 年份 | 买入笔数 | 卖出笔数 | 数据状态 |
|------|----------|----------|----------|
| 2015 | 12,411   | 12,290   | ✅ 完整  |
| 2016 | 4,882    | 4,888    | ✅ 完整  |
| 2017 | 3,695    | 3,697    | ✅ 完整  |
| 2018 | 5,520    | 5,519    | ✅ 完整  |
| 2019 | 6,110    | 6,100    | ✅ 完整  |
| 2020 | 7,165    | 7,159    | ✅ 完整  |
| 2021 | 8,948    | 8,945    | ✅ 完整  |
| 2022 | 9,130    | 9,141    | ✅ 完整  |
| 2023 | 5,440    | 5,426    | ✅ 完整  |
| 2024 | 9,276    | 9,284    | ✅ 完整  |
| 2025 | 6,626    | 6,754    | ⚠️ 部分  |

**注意**：2025年数据截至 2025-11-04，不是完整年度数据。

---

## 报告内容说明

每个年度报告包含：
- **统计区间**：该年 1月1日 至 12月31日（或最后交易日）
- **期初持仓**：正确计算该年之前的持仓成本
- **期间交易**：该年度内所有买卖交易
- **期末持仓**：该年最后一天的持仓情况（包括跨年持仓）
- **收益分析**：该年度的收益率、回撤、夏普比率等
- **持仓分析**：行业分布、个股明细、换手率等

---

## 示例

### 生成 2024 年报告

**方法1（快速）：**
```bash
# 编辑 config.py
# REPORT_YEAR = "2024"
# CSV_FILE = DOCS_DIR / "交割单.csv"

python3 generate_report.py
```

**方法2（批量）：**
```bash
python3 generate_yearly_reports.py 2024
```

### 生成最近3年报告
```bash
python3 generate_yearly_reports.py 2022 2023 2024
```

或

```bash
python3 generate_yearly_reports.py 2022-2024
```

---

## 技术细节

### 跨年交易处理

系统会正确处理跨年交易：

**示例**：某只股票在 2024-12-20 买入，2025-01-10 卖出

- **2024年报告**：
  - 期末持仓中包含这只股票
  - 持仓成本计入 2024 年末总资产
  - 不计入卖出收益（因为还未卖出）

- **2025年报告**：
  - 期初持仓中包含这只股票（成本来自2024年）
  - 1月10日卖出时计算收益
  - 该笔收益计入 2025 年度

### 计算方法

```
持仓成本 = 累计买入金额 - 已卖出股票的买入成本

- 买入时：持仓成本 += buy_money
- 卖出时：持仓成本 -= 该笔交易的 buy_money（配对格式）

总资产 = 持仓成本 + 现金
现金 = 初始资金 - 累计买入 + 累计卖出
```

---

## 常见问题

### Q1: 为什么2015年报告和完整报告的总资产不一样？
A: 因为统计区间不同：
- 2015年报告：只统计 2015-01-05 至 2015-12-31
- 完整报告：统计 2015-01-05 至 2025-11-04

### Q2: 跨年持仓怎么处理？
A: 系统会自动处理：
- 2015买入但2016卖出的股票，其成本会计入2015年末持仓
- 2016年报告会正确识别这些期初持仓并计算收益

### Q3: 如何生成完整期间（不限年份）的报告？
A: 设置 `REPORT_YEAR = None` 即可：
```python
# config.py
REPORT_YEAR = None  # 统计所有年份
```

### Q4: 批量生成会覆盖之前的报告吗？
A: 是的，目前每次生成都会覆盖 `私募基金报告_交割单.pdf`。
建议每生成一个年份后，手动重命名文件：
```bash
mv 私募基金报告_交割单.pdf 私募基金报告_2024年.pdf
```

---

## 性能优化

生成单个年份报告大约需要：
- 2015年（12,411笔）：约 30-60 秒
- 2024年（9,276笔）：约 30-60 秒
- 完整数据（79,203笔）：约 2-5 分钟

如果需要加速：
1. 确保已安装所有依赖包
2. 使用 SSD 硬盘
3. 关闭不必要的后台程序

---

**更多问题请参考 README.md**
